<script setup>
import navbar from '@/pages/components/navbar.vue'
import QreviewImage from '../../pages/components/q-previewImage.vue'

import { baseURL } from '@/utils/http'
import { useNotify, useToast, useMessage } from 'wot-design-uni' // uiÁªÑ‰ª∂Â∫ì
import { useWorkStore, useUserStore } from '@/store'
import { appDisposeOrder, complete, appDisposeOrderInfo } from '@/api'
import { pathToBase64, base64ToPath } from "@/utils/tools.js"; // ÂõæÁâáËΩ¨base64
import dayjs from "dayjs";

const { workHandle } = storeToRefs(useWorkStore()) // ‰º†ÈÄíËøáÊù•ÁöÑÂ∑•Âçï‰ø°ÊÅØ
const Toast = useToast() // ÊèêÁ§∫Ê°Ü
const segmented = ref(0) // tabÂàáÊç¢
const userStore = useUserStore() // Áî®Êà∑‰ø°ÊÅØ
const { userInfo, userMap } = storeToRefs(userStore) // Áî®Êà∑‰ø°ÊÅØ
const isIos = ref(false) // ÊòØÂê¶ÊòØios
const watermarkUrl = ref("https://report.gb19056.com/watermark/") // Ê∞¥Âç∞Áõ∏Êú∫Âú∞ÂùÄ
const openWebview = ref(false)  // ÊòØÂê¶ÊâìÂºÄÊ∞¥Âç∞Áõ∏Êú∫
const previewImage = ref(null); // ÂõæÁâáÈ¢ÑËßàdom
const sheetShow = ref(false) // ÈÄâÊã©‰∏ä‰º†ÊñπÂºèÂºπÊ°Ü
const upType = ref(null) // ‰∏ä‰º†Á±ªÂûã
const holdType = ref(null) // È¢ÑËßàÁ±ªÂûã
const holdIdx = ref(null) // È¢ÑËßàÁ±ªÂûã
const upIdx = ref(null)

const variableXZ = { //Êñ∞Ë£Ö
  deviceType: null, // ËÆæÂ§áÁ±ªÂûã ,
  carPlate: null, // ËΩ¶ÁâåÂè∑Á†Å 
  carType: null, // ËΩ¶ËæÜÁ±ªÂûã
  beforeApplyPic: [], // Áª¥Êä§ÂâçÁÖßÁâá ,
  deviceBrand: null,//ËÆæÂ§áÂìÅÁâå ,
  deviceSerial: null,//ËÆæÂ§áÂ∫èÂàóÂè∑ ,
  deviceModel: null, // ËÆæÂ§áÂûãÂè∑
  simNum: null,//simÂç°Âè∑
  channelType: [],//ÈÄöÈÅìÁ±ªÂûã , 
  xzContent: null,// Êñ∞Ë£ÖÂÜÖÂÆπ
  afterApplyPic: [],//ÊñΩÂ∑•ÂêéÁÖßÁâá ,
  remark: null, //Â§áÊ≥®
  // ---------------------------- ÈôÑ‰ª∂ ----------------------------
  drivingLicense: [],//Ë°åÈ©∂ËØÅ ,
  driverLicense: [], // È©æÈ©∂ËØÅ ,
  managerFile: [], // ÁÆ°ÁêÜÂëò‰ø°ÊÅØÈôÑ‰ª∂ ,
  electricalFile: [],// ÁîµÊ∞îÈôÑ‰ª∂ ,
  busFile: [],//ÊÄªÁ∫øÈôÑ‰ª∂
  hostPic: [],//‰∏ªÊú∫ÁÖßÁâá ,
  attachment: [], //ÈôÑ‰ª∂Ê£ÄÊü• ,

}
const variableWH = {//Áª¥Êä§
  carPlate: null,  // ËΩ¶ÁâåÂè∑Á†Å 
  carType: null, // ËΩ¶ËæÜÁ±ªÂûã
  beforeApplyPic: [], // Áª¥Êä§ÂâçÁÖßÁâá ,
  faultType: null, // ÊïÖÈöúÂàÜÁ±ª
  faultReason: null, // ÊïÖÈöúÂéüÂõ† ,
  whType: null, // Áª¥Êä§ÊñπÂºè
  whContent: null, //Áª¥Êä§ÂÜÖÂÆπ ,
  ext1: 0, //‰∏ªÊú∫ 
  ext2: 0,//Á°¨Áõò
  ext3: 0,//UÁõò 
  ext4: 0,//ÊëÑÂÉèÂ§¥
  ext5: 0,// GPSÂ§©Á∫ø ,
  ext6: 0,//4GÂ§©Á∫ø 
  ext7: 0,//ÁîµÊ∫êÁ∫ø
  ext8: 0,//ËßÜÈ¢ëÁ∫ø
  ext9: 0,//ÊòæÁ§∫Â±è
  ext10: 0,//ËΩ¨Êé•Á∫ø
  ext11: 0,//Êú∫ËäØ 
  ext12: 0,//ÁÅØÊùø
  ext13: 0,//Èò≤ÁàÜÁÆ°
  ext14: 0,//‰øùÈô©
  ext15: 0,//ËæÖÊùê
  afterApplyPic: [],//ÊñΩÂ∑•ÂêéÁÖßÁâá ,
  remark: null, //Â§áÊ≥®

  replacePart: null, // Êõ¥Êç¢ÁöÑÈÉ®‰ª∂
  deviceBrand: null,//ËÆæÂ§áÂìÅÁâå ,
  deviceSerial: null,//ËÆæÂ§áÂ∫èÂàóÂè∑ ,
  deviceModel: null, // ËÆæÂ§áÂûãÂè∑
  simNum: null,//simÂç°Âè∑
  channelType: [],//ÈÄöÈÅìÁ±ªÂûã ,
}

const postLcForm = ref({
  comment: 1,
  procInsId: null,
  instanceId: null,
  deployId: null,
  taskId: null,
  variables: {
    comment: 1,
  },
})

const postForm = ref({
  orderId: null, // Â∑•Âçïid
  flowInfo: { // ÊµÅÁ®ã‰ø°ÊÅØ
    taskId: null, // ‰ªªÂä°id
    instanceId: null // ÂÆû‰æãid
  },
  addressInfo: { // Âú∞ÂùÄÊ†∏Êü•
    isLocation: 0, // ÊòØÂê¶Âà∞ËææÁé∞Âú∫ 0Âê¶ 1ÊòØ
    address: null, // Âú∞ÂùÄ
    storePic: [] // Èó®Â∫óÂõæÁâá
  },
  applyInfo: [], // ÊñΩÂ∑•‰ø°ÊÅØ
  signInfo: { // Á≠æÂ≠óÁ°ÆËÆ§
    engieeSign: null, // Â∑•Á®ãÂ∏àÁ≠æÂ≠ó
    userSign: null, // Áî®Êà∑Á≠æÂ≠ó
  }
})


onMounted(() => {
  getLocation()
  if (workHandle.value) {
    postForm.value.orderId = workHandle.value.orderId
    postForm.value.signInfo.orderId = workHandle.value.orderId
    postForm.value.flowInfo.taskId = workHandle.value.taskId
    postForm.value.flowInfo.instanceId = workHandle.value.procInsId

    postLcForm.value.procInsId = workHandle.value.procInsId
    postLcForm.value.instanceId = workHandle.value.procInsId
    postLcForm.value.taskId = workHandle.value.taskId
    postLcForm.value.deployId = workHandle.value.deployId

    console.log("üöÄ ~ onMounted ~ workHandle.value.orderType:", workHandle.value)
    if (workHandle.value.orderType == 2) { // Áª¥Êä§
      postForm.value.applyInfo.push(JSON.parse(JSON.stringify({ ...variableWH })))
    } else if (workHandle.value.orderType == 3) { // Êñ∞Ë£Ö
      postForm.value.applyInfo.push(JSON.parse(JSON.stringify({ ...variableXZ })))
    }
  } else {
    Toast.warning("Ê≤°ÊúâÊâæÂà∞ËØ•Â∑•Âçï‰ø°ÊÅØ")
    setTimeout(() => {
      uni.navigateBack({
        delta: 1
      })
    }, 1000)
  }
  uni.$on('sign', (data) => { // Á≠æÂêçÈ°µÈù¢ËøîÂõû
    if (data.upType == 'engieeSign') postForm.value.signInfo.engieeSign = data.url
    if (data.upType == 'userSign') postForm.value.signInfo.userSign = data.url
  });

  uni.getSystemInfoSync().platform == "ios" ? isIos.value = true : isIos.value = false
  appDisposeOrderInfoFn()
})



//È°µÈù¢ÈîÄÊØÅÊó∂
onUnmounted(() => {
  uni.$off('sign')
  appDisposeOrderFn(postForm.value) // È°µÈù¢ÈîÄÊØÅÊó∂‰øùÂ≠òÂ∑•Âçï
})

const appDisposeOrderInfoFn = async () => {
  uni.showToast({
    title: 'Âä†ËΩΩ‰∏≠...',
    icon: 'loading',
    duration: 2000
  });
  const { code, data, msg } = await appDisposeOrderInfo({
    orderId: workHandle.value.orderId
  })
  if (code != 0) {
    Toast.error(msg)
    uni.hideToast()
  } else {
    uni.hideToast()
    postForm.value.addressInfo = data.addressInfo
    postForm.value.applyInfo = data.applyInfo
    postForm.value.signInfo = data.signInfo
  }
}

const submitBtn = async () => { // Êèê‰∫§Â∑•Âçï
  Toast.loading("Êèê‰∫§‰∏≠...");
  const { code, data, msg } = await appDisposeOrder(postForm.value)
  if (code != 0) {
    Toast.error(msg)
    Toast.close()
  } else {
    const { code, data, msg } = await complete(postLcForm.value)
    if (code != 0) {
      Toast.error(msg)
      Toast.close()
    } else {
      Toast.success("Êèê‰∫§ÊàêÂäü")
      Toast.close()
      setTimeout(() => {
        uni.navigateBack({
          delta: 1
        })
      }, 1000)
    }
  }
}

const appDisposeOrderFn = async (value) => {
  const { code, data, msg } = await appDisposeOrder(postForm.value)
  if (code != 0) {
    Toast.error(msg)
  }
}

const addWorkBtn = () => { // Ê∑ªÂä†ÊñΩÂ∑•‰ø°ÊÅØ
  if (workHandle.value.orderType == 2) { // Áª¥Êä§
    postForm.value.applyInfo.push(JSON.parse(JSON.stringify({ ...variableWH })))
  } else if (workHandle.value.orderType == 3) { // Êñ∞Ë£Ö
    postForm.value.applyInfo.push(JSON.parse(JSON.stringify({ ...variableXZ })))
  }
}

const delWorkBtn = (idx) => { // Âà†Èô§ÊñΩÂ∑•‰ø°ÊÅØ
  postForm.value.applyInfo.splice(idx, 1)
}



// Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ
const getLocation = (type) => {
  Toast.loading("ÂÆö‰Ωç‰∏≠...");
  uni.getLocation({
    // type: "wgs84",
    type: "gcj02",
    enableHighAccuracy: true,//È´òÁ≤æÂ∫¶
    success: (res) => {
      Toast.close();
      console.log("resÂÆö‰Ωç", res);
      userMap.value.latitude = res.latitude;
      userMap.value.longitude = res.longitude;
      let isLocation = getDistanceFromLatLonInM(
        res.latitude,
        res.longitude,
        Number(workHandle.value.lat),
        Number(workHandle.value.lng)
      )
      isLocation = isLocation.toFixed(2);
      console.log("isLocation", isLocation);
      if (isLocation < 300) {
        postForm.value.addressInfo.isLocation = 0
        if (type) Toast.success("Ê†°È™åÊàêÂäü");
      } else {
        postForm.value.addressInfo.isLocation = 1
        if (type) Toast.error({
          msg: `Ê†°È™åÂà∞ÊÇ®ÂèØËÉΩÊú™Âà∞ËææÁé∞Âú∫,Ë∑ùÁ¶ªÂ∑•ÂçïÂ§ÑÁêÜÁé∞Âú∫‰ªçÊúâ${isLocation}Á±≥!`,
          duration: 3000
        });
      }
      getAddress(res.latitude, res.longitude).then((res) => {
        postForm.value.addressInfo.address = res.data.regeocode.formatted_address
      })
    },
    fail: (err) => {
      postForm.value.addressInfo.isLocation = 1
      Toast.close();
      Toast.error("ÂÆö‰ΩçÂ§±Ë¥•");
      console.log(err);
    },
  });
};

const getDistanceFromLatLonInM = (lat1, lon1, lat2, lon2) => { // ËÆ°ÁÆó‰∏§ÁÇπ‰πãÈó¥ÁöÑË∑ùÁ¶ª
  console.log(lat1, lon1, lat2, lon2);
  if (!lat2 || !lat2) return Toast.error("Êú™Ëé∑ÂèñÂà∞Â∑•Âçï‰ΩçÁΩÆ‰ø°ÊÅØ!")
  Number.prototype.deg2rad = function (deg) {
    return deg * (Math.PI / 180);
  };
  var R = 6371; // // ÊòØÂú∞ÁêÉÂçäÂæÑÔºåÂçï‰ΩçÊòØÂçÉÁ±≥ÔºåËøôÈáåÁöÑ6371ÊòØÂçÉÁ±≥
  var dLat = (0).deg2rad(lat2 - lat1); // deg2rad below
  var dLon = (0).deg2rad(lon2 - lon1);
  var a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos((0).deg2rad(lat1)) *
    Math.cos((0).deg2rad(lat2)) *
    Math.sin(dLon / 2) *
    Math.sin(dLon / 2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  var d = R * c * 1000; // Distance in meters
  return d;
};

const tabChange = (index) => { }

const nextStep = (index) => {
  segmented.value = index
}


//ÈÄöËøáÁªèÁ∫¨Â∫¶Ëé∑ÂèñÈ´òÂæ∑Âú∞ÂõæËØ¶ÁªÜÂú∞ÂùÄ
const getAddress = (lat, lng) => {
  return new Promise((resolve, reject) => {
    uni.request({
      url: `https://restapi.amap.com/v3/geocode/regeo?location=${lng},${lat}&key=5b53822df7d7324e6306268237692ba6&extensions=base`,
      success: (result) => {
        console.log("üöÄ ~ returnnewPromise ~ result:", result)
        resolve(result)
      },
      fail: (error) => {
        reject(error)
      }
    });
  })
}


const upBtn = (type, idx) => {
  console.log("üöÄ ~ upBtn ~ type:", type)
  console.log("üöÄ ~ upBtn ~ idx:", idx)
  upType.value = type // ÂΩìÂâç‰∏ä‰º†Á±ªÂûã
  upIdx.value = idx
  if (userInfo.value.userType == 2) { // Â¶ÇÊûúÊòØ‰∏ªÁÆ° ÂèØ‰ª•ÈÄâÊã©ÊÄß‰∏ä‰º†
    sheetShow.value = true
  } else { // Â¶ÇÊûúÊòØÂ∑•Á®ãÂ∏à Âè™ËÉΩÁé∞Âú∫ÊãçÁÖß
    upImgFn()
    //upAlbum()
  }
}

const sheetSelect = ({ index }) => { // ÈÄâÊã©‰∏ä‰º†ÊñπÂºè
  sheetShow.value = false
  if (index == 0) { //Áé∞Âú∫ÊãçÁÖß
    upImgFn()
  } else { // ‰∏ä‰º†Áõ∏ÂÜåÁöÑÂõæÁâá
    upAlbum()
  }
}

const upAlbum = () => {
  uni.chooseImage({
    count: 9,
    sizeType: ["original", "compressed"],
    sourceType: ["album"],
    success: (res) => {
      let tempFilePaths = res.tempFilePaths;
      tempFilePaths.forEach((item) => {
        uploadFileApi(item)
      });
    },
  });
}


const upImgFn = () => { // ‰∏ä‰º†ÂõæÁâáÊ∞¥Âç∞
  let platform = uni.getSystemInfoSync().platform;
  if (platform === "ios") {
    //¬†ËãπÊûú
    console.log("ËãπÊûúÂèØ‰ª•‰ΩøÁî®Áõ∏Êú∫Áõ∏ÂÜå");
    watermarkOk();
  } else if (platform === "android") {
    console.log("ÂÆâÂçì");
    //¬†ÂÆâÂçì
    //ËΩØ‰ª∂Ëé∑ÂèñÁõ∏Êú∫ÊùÉÈôê
    plus.android.requestPermissions(["android.permission.CAMERA"], (e) => {
      console.log("Áõ∏Êú∫ÊùÉÈôê");
      if (e.deniedAlways.length > 0) {
        // ÂºπÂá∫ÊèêÁ§∫Ê°ÜËß£Èáä‰∏∫‰ΩïÈúÄË¶ÅÊùÉÈôêÔºåÂºïÂØºÁî®Êà∑ÊâìÂºÄËÆæÁΩÆÈ°µÈù¢ÂºÄÂêØ
        uni.showModal({
          title: "ÊèêÁ§∫",
          content:
            "ËØ∑ÊâìÂºÄÊâãÊú∫Áõ∏Êú∫Áõ∏ÂÜåÂäüËÉΩÔºàÁÇπÂáªÁ°ÆÂÆöÂêéÂú®ÊùÉÈôê‰∏≠ÊéàÊùÉÁõ∏Êú∫Áõ∏ÂÜåÂäüËÉΩÔºâ",
          // showCancel: false, // ‰∏çÊòæÁ§∫ÂèñÊ∂àÊåâÈíÆ
          success(res) {
            if (res.confirm) {
              var Intent = plus.android.importClass(
                "android.content.Intent"
              );
              var Settings = plus.android.importClass(
                "android.provider.Settings"
              );
              var Uri = plus.android.importClass("android.net.Uri");
              var mainActivity = plus.android.runtimeMainActivity();
              var intent = new Intent();
              intent.setAction(
                Settings.ACTION_APPLICATION_DETAILS_SETTINGS
              );
              var uri = Uri.fromParts(
                "package",
                mainActivity.getPackageName(),
                null
              );
              intent.setData(uri);
              mainActivity.startActivity(intent);
            }
          },
        });
      } else if (e.deniedPresent.length > 0) {
        //ÊùÉÈôêË¢´‰∏¥Êó∂ÊãíÁªù
        // ÂºπÂá∫ÊèêÁ§∫Ê°ÜËß£Èáä‰∏∫‰ΩïÈúÄË¶ÅÊùÉÈôêÔºåÂèØÂÜçÊ¨°Ë∞ÉÁî®plus.android.requestPermissionsÁî≥ËØ∑ÊùÉÈôê
        uni.showModal({
          title: "ÊèêÁ§∫",
          content: "ËØ∑ÊâìÂºÄÊâãÊú∫Áõ∏Êú∫ÂäüËÉΩÔºàÁÇπÂáªÁ°ÆÂÆöÂêéÂú®ÊùÉÈôê‰∏≠ÊéàÊùÉÁõ∏Êú∫ÂäüËÉΩÔºâ",
          // showCancel: false, // ‰∏çÊòæÁ§∫ÂèñÊ∂àÊåâÈíÆ
          success(res) {
            if (res.confirm) {
              var Intent = plus.android.importClass(
                "android.content.Intent"
              );
              var Settings = plus.android.importClass(
                "android.provider.Settings"
              );
              var Uri = plus.android.importClass("android.net.Uri");
              var mainActivity = plus.android.runtimeMainActivity();
              var intent = new Intent();
              intent.setAction(
                Settings.ACTION_APPLICATION_DETAILS_SETTINGS
              );
              var uri = Uri.fromParts(
                "package",
                mainActivity.getPackageName(),
                null
              );
              intent.setData(uri);
              mainActivity.startActivity(intent);
            }
          },
        });
      } else {
        plus.android.requestPermissions(
          ["android.permission.READ_EXTERNAL_STORAGE"],
          (e) => {
            if (e.deniedAlways.length > 0) {
              //ÊùÉÈôêË¢´Ê∞∏‰πÖÊãíÁªù
              // ÂºπÂá∫ÊèêÁ§∫Ê°ÜËß£Èáä‰∏∫‰ΩïÈúÄË¶ÅÊùÉÈôêÔºåÂºïÂØºÁî®Êà∑ÊâìÂºÄËÆæÁΩÆÈ°µÈù¢ÂºÄÂêØ
              uni.showModal({
                title: "ÊèêÁ§∫",
                content:
                  "ËØ∑ÊâìÂºÄÁõ∏ÂÜåÂ≠òÂÇ®ÂäüËÉΩÔºàÁÇπÂáªÁ°ÆÂÆöÂêéÂú®ÊùÉÈôê‰∏≠ÊéàÊùÉÁõ∏ÂÜåÂ≠òÂÇ®ÂäüËÉΩÔºâ",
                // showCancel: false, // ‰∏çÊòæÁ§∫ÂèñÊ∂àÊåâÈíÆ
                success(res) {
                  if (res.confirm) {
                    var Intent = plus.android.importClass(
                      "android.content.Intent"
                    );
                    var Settings = plus.android.importClass(
                      "android.provider.Settings"
                    );
                    var Uri = plus.android.importClass("android.net.Uri");
                    var mainActivity = plus.android.runtimeMainActivity();
                    var intent = new Intent();
                    intent.setAction(
                      Settings.ACTION_APPLICATION_DETAILS_SETTINGS
                    );
                    var uri = Uri.fromParts(
                      "package",
                      mainActivity.getPackageName(),
                      null
                    );
                    intent.setData(uri);
                    mainActivity.startActivity(intent);
                  }
                },
              });
            } else if (e.deniedPresent.length > 0) {
              //ÊùÉÈôêË¢´‰∏¥Êó∂ÊãíÁªù
              // ÂºπÂá∫ÊèêÁ§∫Ê°ÜËß£Èáä‰∏∫‰ΩïÈúÄË¶ÅÊùÉÈôêÔºåÂèØÂÜçÊ¨°Ë∞ÉÁî®plus.android.requestPermissionsÁî≥ËØ∑ÊùÉÈôê
              uni.showModal({
                title: "ÊèêÁ§∫",
                content:
                  "ËØ∑ÊâìÂºÄÁõ∏ÂÜåÂ≠òÂÇ®ÂäüËÉΩÔºàÁÇπÂáªÁ°ÆÂÆöÂêéÂú®ÊùÉÈôê‰∏≠ÊéàÊùÉÁõ∏ÂÜåÂ≠òÂÇ®ÂäüËÉΩÔºâ",
                // showCancel: false, // ‰∏çÊòæÁ§∫ÂèñÊ∂àÊåâÈíÆ
                success(res) {
                  if (res.confirm) {
                    var Intent = plus.android.importClass(
                      "android.content.Intent"
                    );
                    var Settings = plus.android.importClass(
                      "android.provider.Settings"
                    );
                    var Uri = plus.android.importClass("android.net.Uri");
                    var mainActivity = plus.android.runtimeMainActivity();
                    var intent = new Intent();
                    intent.setAction(
                      Settings.ACTION_APPLICATION_DETAILS_SETTINGS
                    );
                    var uri = Uri.fromParts(
                      "package",
                      mainActivity.getPackageName(),
                      null
                    );
                    intent.setData(uri);
                    mainActivity.startActivity(intent);
                  }
                },
              });
            } else {
              // console.log("ÂÆâÂçìÂèØ‰ª•‰ΩøÁî®Áõ∏Êú∫Áõ∏ÂÜå");
              watermarkOk();
            }
          }
        );
      }
    });
  }
}

const watermarkOk = () => { //Ë∞ÉÁî®Ê∞¥Âç∞Áõ∏Êú∫
  console.log("ÂÆâÂçìÂèØ‰ª•‰ΩøÁî®Áõ∏Êú∫Áõ∏ÂÜå");
  let watermarkInfo = JSON.stringify({
    location: "ÁªèÁ∫¨Â∫¶: " + userMap.value.longitude + "N, " + userMap.value.latitude + "E",
    name: "ÊñΩÂ∑•‰∫∫Âëò: " + userInfo.value.userName,
    time: "Êó∂Èó¥: " + dayjs().format("YYYY-MM-DD HH:mm:ss"),
    address: "Âú∞ÂùÄ: " + postForm.value.addressInfo.address ? postForm.value.addressInfo.address : workHandle.value.address,
    titleStr: upObj[upType.value],
  });
  watermarkUrl.value = `https://report.gb19056.com/watermark/?watermarkInfo=${watermarkInfo}&`;
  openWebview.value = true;
}

const handleMessage = (event) => { // Ê∞¥Âç∞Áõ∏Êú∫ËøîÂõûÁöÑÊï∞ÊçÆ
  openWebview.value = false;
  // let watermarkInfo = JSON.parse(event.detail.data[0].query.watermarkInfo);
  let watermarkImgs = event.detail.data[0].imgs;
  if (watermarkImgs && watermarkImgs.length > 0) {
    watermarkImgs.forEach((item) => {
      base64ToPath(item)
        .then((path) => {
          uploadFileApi(path)
        })
        .catch((error) => {
          console.error(error);
        });
    });
  }
}

const uploadFileApi = async (path) => { //‰∏ä‰º†ÂõæÁâáÊé•Âè£
  uni.uploadFile({
    url: baseURL + "sysFile/uploadFile",
    filePath: path,
    name: "file",
    formData: {
      fileName: "Â∑•ÂçïÂõæÁâá",
    },
    success: (uploadFileRes) => {
      const { data } = JSON.parse(uploadFileRes.data);
      console.log("üöÄ ~ uploadFileApi ~ data:", data)
      if (upType.value == "storePic") { //  Èó®Â∫óÂõæÁâá
        postForm.value.addressInfo.storePic.push(data.url)
      } else if (upType.value == "beforeApplyPic") { // ÊñΩÂ∑•ÂâçÁÖßÁâá
        postForm.value.applyInfo[upIdx.value].beforeApplyPic.push(data.url)
      } else if (upType.value == "afterApplyPic") { // ÊñΩÂ∑•ÂêéÁÖßÁâá
        postForm.value.applyInfo[upIdx.value].afterApplyPic.push(data.url)
      }
    },
  });
}
const upObj = { // ‰∏ä‰º†ÂõæÁâáÁ±ªÂûãÊò†Â∞ÑË°®
  "storePic": "Èó®Â∫óÂõæÁâá",
  "beforeApplyPic": "ÊñΩÂ∑•ÂâçÁÖßÁâá",
  "afterApplyPic": "ÊñΩÂ∑•ÂêéÁÖßÁâá",
}

const sheetActions = [ // ÈÄâÊã©‰∏ä‰º†ÊñπÂºè
  {
    name: 'Áé∞Âú∫ÊãçÁÖß',
    subname: 'Ê∞¥Âç∞Áõ∏Êú∫'
  },
  {
    name: 'ÊâãÊú∫Áõ∏ÂÜå‰∏ä‰º†',
  }
]

const variableList = ref([]) // ÈúÄË¶ÅÈ¢ÑËßàÁöÑÂõæÁâáÂàóË°®
const onLongpress = e => { // ÂõæÁâáÈ¢ÑËßàÈïøÊåâ‰∫ã‰ª∂
  console.log('ÂΩìÂâçÈïøÊåâÁöÑÂõæÁâáÊòØ' + e);
  uni.showActionSheet({
    itemList: ['Âà†Èô§', '‰øùÂ≠òÂà∞ÊâãÊú∫'],
    success: function (res) {
      if (res.tapIndex == 0) {
        variableList.value.forEach((item, idx) => {
          if (item == e) {
            console.log("holdIdx.value", holdIdx.value);
            console.log("holdType.value", holdType.value);
            variableList.value.splice(idx, 1);
            if (holdType.value == 'storePic') {
              postForm.value.addressInfo.storePic.splice(idx, 1);
            } else {
              postForm.value.applyInfo[holdIdx.value][holdType.value].splice(idx, 1);
            }

            previewImage.value.open(variableList.value[0]);
          }
        });
      } else if (res.tapIndex == 1) {
        //‰øùÂ≠òÂà∞ÊâãÊú∫
        uni.downloadFile({
          url: e, // ËøôÈáåÊòØ‰Ω†ÁöÑÂõæÁâáurl
          success: (downloadResult) => {
            if (downloadResult.statusCode === 200) {
              uni.saveImageToPhotosAlbum({
                filePath: downloadResult.tempFilePath,
                success: () => {
                  uni.showToast({
                    title: '‰øùÂ≠òÊàêÂäü!',
                    icon: 'success',
                    duration: 2000
                  });
                },
                fail: (err) => {
                  uni.showToast({
                    title: '‰øùÂ≠òÂ§±Ë¥•!',
                    icon: 'error',
                    duration: 2000
                  });
                }
              });
            }
          },
          fail: (err) => {
            console.log('‰∏ãËΩΩÂ§±Ë¥•', err);
          }
        });
      }
    },
    fail: function (res) {
      console.log(res.errMsg);
    }
  });
}

const lookover = (urls, urlIdx, ylIdx, hold) => { // ÁÇπÂáªÂõæÁâáÈ¢ÑËßà
  console.log("üöÄ ~ lookover ~ ylIdx:", ylIdx)
  holdType.value = hold //È¢ÑËßàÂõæÁâáÁöÑÁ±ªÂûã
  holdIdx.value = ylIdx //È¢ÑËßàÂõæÁâáÁöÑ‰∏ãÊ†á

  variableList.value = urls.map(item => baseURL + item)
  setTimeout(() => {
    previewImage.value.open(baseURL + urls[urlIdx]); // ‰º†ÂÖ•ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂõæÁâáÂú∞ÂùÄ(Â∞èÁ®ãÂ∫èÂøÖÈ°ªÊ∑ªÂä†$nextTickÔºåËß£ÂÜ≥ÁªÑ‰ª∂È¶ñÊ¨°Âä†ËΩΩÊó†Âõæ)
  }, 100)
}

// --------------------------------------------------Á≠æÂêç --------------------------------------

const goSign = (e) => {
  uni.navigateTo({
    url: `/pagesFn/work/signature?upType=${e}`
  })
}

// --------------------------------------------------Â∑•ÂçïÁª¥Êä§ÈÄâÈ°π‰ø°ÊÅØ --------------------------------------
const vehicleTypeList = [// ËΩ¶ËæÜÁ±ªÂûã
  {//       
    label: '‰∏ì‰∏öÂ∑•Á®ãËøêËæìËΩ¶',
    value: '‰∏ì‰∏öÂ∑•Á®ãËøêËæìËΩ¶'
  },
  {
    label: 'Ê∏£ÂúüËΩ¶',
    value: 'Ê∏£ÂúüËΩ¶'
  },
  {
    label: 'ÁâµÂºïËΩ¶',
    value: 'ÁâµÂºïËΩ¶'
  },
  {
    label: 'ÊåÇËΩ¶',
    value: 'ÊåÇËΩ¶'
  },
  {
    label: 'ÁΩêËΩ¶',
    value: 'ÁΩêËΩ¶'
  },
  {
    label: 'Âçï‰ΩçËá™Áî®',
    value: 'Âçï‰ΩçËá™Áî®'
  },
  {
    label: 'Â∑•Á®ãËΩ¶',
    value: 'Â∑•Á®ãËΩ¶'
  },
  {
    label: 'ÈáçÂûãË¥ßËΩ¶',
    value: 'ÈáçÂûãË¥ßËΩ¶'
  },
  {
    label: '‰∏≠ÂûãË¥ßËΩ¶',
    value: '‰∏≠ÂûãË¥ßËΩ¶'
  },
  {
    label: 'Â∞èÂûãË¥ßËΩ¶',
    value: 'Â∞èÂûãË¥ßËΩ¶'
  },
  {
    label: 'ÂÖ∂‰ªñ',
    value: 'ÂÖ∂‰ªñ'
  },

]
const breakdownTypeList = [  // ÊïÖÈöúÂàÜÁ±ª
  {
    label: '‰∏¢ÈáåÁ®ã',
    value: '‰∏¢ÈáåÁ®ã'
  },
  {
    label: 'Êó†‰ø°Âè∑',
    value: 'Êó†‰ø°Âè∑'
  },
  {
    label: 'Êó†ÂÆö‰Ωç',
    value: 'Êó†ÂÆö‰Ωç'
  },
  {
    label: 'ÁªàÁ´ØÁ¶ªÁ∫ø',
    value: 'ÁªàÁ´ØÁ¶ªÁ∫ø'
  },
  {
    label: 'ÁªàÁ´ØÊºÇÁßª',
    value: 'ÁªàÁ´ØÊºÇÁßª'
  },
  {
    label: 'ÁîªÈù¢Èó™ÁÉÅ',
    value: 'ÁîªÈù¢Èó™ÁÉÅ'
  },
  {
    label: '‰∏ªÊú∫ÈáçÂêØ',
    value: '‰∏ªÊú∫ÈáçÂêØ'
  },
  {
    label: 'Êõ¥Êç¢Á°¨Áõò',
    value: 'Êõ¥Êç¢Á°¨Áõò'
  },
  {
    label: 'Êõ¥Êç¢SimÂç°',
    value: 'Êõ¥Êç¢SimÂç°'
  },
  {
    label: 'Êõ¥Êç¢ÊëÑÂÉèÂ§¥',
    value: 'Êõ¥Êç¢ÊëÑÂÉèÂ§¥'
  },
  {
    label: 'Â§©Á∫øÂÆâË£ÖÂºÇÂ∏∏',
    value: 'Â§©Á∫øÂÆâË£ÖÂºÇÂ∏∏'
  },
  {
    label: 'ÁªàÁ´ØÂÆâË£ÖÂºÇÂ∏∏',
    value: 'ÁªàÁ´ØÂÆâË£ÖÂºÇÂ∏∏'
  },
  {
    label: 'ÂÖ∂‰ªñ',
    value: 'ÂÖ∂‰ªñ'
  },

]
const failureCauseList = [ //ÊïÖÈöúÂéüÂõ†
  {
    label: '‰ΩøÁî®‰∏çÂΩì',
    value: '‰ΩøÁî®‰∏çÂΩì'
  },
  {
    label: 'ËÆæÂ§áË¥®ÈáèÈóÆÈ¢ò',
    value: 'ËÆæÂ§áË¥®ÈáèÈóÆÈ¢ò'
  },
  {
    label: '‰∫∫‰∏∫ÂéüÂõ†',
    value: '‰∫∫‰∏∫ÂéüÂõ†'
  },
  {
    label: 'Ê≠£Â∏∏ÊçüÂùè',
    value: 'Ê≠£Â∏∏ÊçüÂùè'
  },
  {
    label: 'simÂç°ÂéüÂõ†',
    value: 'simÂç°ÂéüÂõ†'
  },
  {
    label: '‰∏ªÊú∫ÊïÖÈöú',
    value: '‰∏ªÊú∫ÊïÖÈöú'
  },
  {
    label: 'ÊëÑÂÉèÂ§¥ÊïÖÈöú',
    value: 'ÊëÑÂÉèÂ§¥ÊïÖÈöú'
  },
  {
    label: 'Á∫øË∑ØÊïÖÈöú',
    value: 'Á∫øË∑ØÊïÖÈöú'
  },
  {
    label: 'Â≠òÂÇ®ÊïÖÈöú',
    value: 'Â≠òÂÇ®ÊïÖÈöú'
  },
  {
    label: 'ÁÅØÊùøÊïÖÈöú',
    value: 'ÁÅØÊùøÊïÖÈöú'
  },
  {
    label: 'ËæÖÊùêÊïÖÈöú',
    value: 'ËæÖÊùêÊïÖÈöú'
  },
  {
    label: 'Â§©Á∫øÊïÖÈöú',
    value: 'Â§©Á∫øÊïÖÈöú'
  },
  {
    label: 'ÂÖ∂‰ªñ',
    value: 'ÂÖ∂‰ªñ'
  },
]
const maintenanceMode = ref([
  {
    label: 'Áª¥Êä§Â§ÑÁêÜ',
    value: 'Áª¥Êä§Â§ÑÁêÜ'
  },
  {
    label: 'Êõ¥Êç¢ÈÉ®‰ª∂',
    value: 'Êõ¥Êç¢ÈÉ®‰ª∂'
  },
])
const changeList = ref([
  {
    label: '‰∏ªÊú∫',
    value: '‰∏ªÊú∫'
  },
  {
    label: 'ÊëÑÂÉèÊú∫Á°¨Áõò',
    value: 'ÊëÑÂÉèÊú∫Á°¨Áõò'
  },
  {
    label: 'ÂÇ®Â≠òÂç°',
    value: 'ÂÇ®Â≠òÂç°'
  },
  {
    label: 'ÈÄöËÆØÊ®°Âùó',
    value: 'ÈÄöËÆØÊ®°Âùó'
  },
  {
    label: 'ÂÆö‰ΩçÊ®°Âùó',
    value: 'ÂÆö‰ΩçÊ®°Âùó'
  },
  {
    label: 'ÈÄöËÆØÂ§©Á∫ø',
    value: 'ÈÄöËÆØÂ§©Á∫ø'
  },
  {
    label: 'ÂÆö‰ΩçÂ§©Á∫ø',
    value: 'ÂÆö‰ΩçÂ§©Á∫ø'
  },
  {
    label: 'Áâ©ËÅîÂç°',
    value: 'Áâ©ËÅîÂç°'
  },
])
const equipmentList = ref([
  {
    label: 'Â§ßÂçé',
    value: 'Â§ßÂçé'
  },
  {
    label: 'Êµ∑Â∫∑',
    value: 'Êµ∑Â∫∑'
  },
  {
    label: 'ÂÖ∂‰ªñ',
    value: 'ÂÖ∂‰ªñ'
  }
])

const aisleList = ref([
  {
    label: "ÈÄöÈÅì1",
    value: '1',
  },
  {
    label: "ÈÄöÈÅì2",
    value: '2',
  },
  {
    label: "ÈÄöÈÅì3",
    value: '3',
  },
  {
    label: "ÈÄöÈÅì4",
    value: '4',
  },
  {
    label: "ÈÄöÈÅì5",
    value: '5',
  },
  {
    label: "ÈÄöÈÅì6",
    value: '6',
  },
  {
    label: "ÈÄöÈÅì7",
    value: '7',
  },
  {
    label: "ÈÄöÈÅì8",
    value: '8',
  },
  {
    label: "ÈÄöÈÅì9",
    value: '9',
  },
  {
    label: "ÈÄöÈÅì10",
    value: '10',
  },
  {
    label: "ÈÄöÈÅì11",
    value: '11',
  },
  {
    label: "ÈÄöÈÅì12",
    value: '12',
  },
  {
    label: "ÈÄöÈÅì13",
    value: '13',
  },
  {
    label: "ÈÄöÈÅì14",
    value: '14',
  },
  {
    label: "ÈÄöÈÅì15",
    value: '15',
  },
  {
    label: "ÈÄöÈÅì16",
    value: '16',
  },
])

const maintenanceModeChange = (val, item) => {
  item.whContent = ''  //Áª¥Êä§ÂÜÖÂÆπ
  item.ext1 = 0
  item.ext2 = 0
  item.ext3 = 0
  item.ext4 = 0
  item.ext5 = 0
  item.ext6 = 0
  item.ext7 = 0
  item.ext8 = 0
  item.ext9 = 0
  item.ext10 = 0
  item.ext11 = 0
  item.ext12 = 0
  item.ext13 = 0
  item.ext14 = 0
  item.ext15 = 0

  item.replacePart = null // Êõ¥Êç¢ÁöÑÈÉ®‰ª∂
  item.deviceBrand = null // ËÆæÂ§áÂìÅÁâå
  item.deviceSerial = null // ËÆæÂ§áÂ∫èÂàóÂè∑
  item.deviceModel = null // ËÆæÂ§áÂûãÂè∑
  item.simNum = null // simÂç°Âè∑
  item.channelType = [] // ÈÄöÈÅìÁ±ªÂûã
}
// --------------------------------------------------Â∑•ÂçïÊñ∞Ë£ÖÈÄâÈ°π‰ø°ÊÅØ --------------------------------------

const carTypeList = [// ËΩ¶ËæÜÁ±ªÂûã
  {
    label: 'ÂÆö‰ΩçÁªàÁ´Ø',
    value: 'ÂÆö‰ΩçÁªàÁ´Ø'
  },
  {
    label: 'ËßÜÈ¢ëÁªàÁ´Ø',
    value: 'ËßÜÈ¢ëÁªàÁ´Ø'
  },
  {
    label: 'Âú∫Âú∞ÁõëÊéß',
    value: 'Âú∫Âú∞ÁõëÊéß'
  },
  {
    label: 'ÈÄöÁî®ËÆæÂ§á',
    value: 'ÈÄöÁî®ËÆæÂ§á'
  },
  {
    label: 'Ê±ΩËΩ¶Ë°åÈ©∂ËÆ∞ÂΩï‰ª™',
    value: 'Ê±ΩËΩ¶Ë°åÈ©∂ËÆ∞ÂΩï‰ª™'
  },
]

const carTypeChange = (item) => {
  if (item.deviceType != 'Ê±ΩËΩ¶Ë°åÈ©∂ËÆ∞ÂΩï‰ª™') {
    item.drivingLicense = []
    item.driverLicense = []
    item.managerFile = []
    item.electricalFile = []
    item.busFile = []
    item.hostPic = []
    item.attachment = []
  } else {
    item.xzContent = ''
    item.beforeApplyPic = []
    item.afterApplyPic = []
  }
}

// --------------------------------------------------Ë°åËΩ¶ËÆ∞ÂΩï‰ª™Êñ∞Ë£Ö ‰∏ä‰º†ÂõæÁâá --------------------------------------

const upBtns = (imgList, idx) => { // imgListÊòØÈúÄË¶Å‰∏ä‰º†ÁöÑÂõæÁâáÊï∞ÁªÑ idxÊòØÂΩìÂâçÁÇπÂáªÁöÑÂõæÁâá‰∏ãÊ†á
  console.log("üöÄ ~ upBtn ~ imgList:", imgList)
  console.log("üöÄ ~ upBtn ~ idx:", idx)
  uni.chooseImage({
    count: 9,
    sizeType: ["original", "compressed"],  // ÂèØ‰ª•ÊåáÂÆöÊòØÂéüÂõæËøòÊòØÂéãÁº©ÂõæÔºåÈªòËÆ§‰∫åËÄÖÈÉΩÊúâ
    sourceType: ["album", "camera"],
    success: (res) => {
      let tempFilePaths = res.tempFilePaths;
      tempFilePaths.forEach((item) => {
        uni.uploadFile({
          url: baseURL + "sysFile/uploadFile",
          filePath: item,
          name: "file",
          formData: {
            fileName: "Â∑•ÂçïÂõæÁâá",
          },
          success: (uploadFileRes) => {
            const { data } = JSON.parse(uploadFileRes.data);
            imgList.push(data.url)
          },
        });
      });
    },
  });
}

</script>
<template>
  <wd-toast></wd-toast>
  <view class="handleWork">
    <navbar :title="'Â§ÑÁêÜÂ∑•Âçï'" />
    <view class="details_center">
      <view class="top_segmented">
        <view class="operate_box" v-if="segmented == 1">
          <image class="operate_img" @tap="addWorkBtn" src="http://116.62.107.90:8673/images/icons/addWork.png"
            mode="scaleToFill" />
        </view>
        <wd-tabs v-model="segmented" @change="tabChange">
          <block>
            <wd-tab title="Âú∞ÂùÄÊ†∏Êü•">
            </wd-tab>
          </block>
          <block>
            <wd-tab title="ÊñΩÂ∑•‰ø°ÊÅØ">

            </wd-tab>
          </block>
          <block>
            <wd-tab title="Á≠æÂ≠óÁ°ÆËÆ§">
            </wd-tab>
          </block>
        </wd-tabs>
      </view>

      <scroll-view scroll-y :show-scrollbar="false" class="segmented_center ">
        <view class="center center1" v-show="segmented == 0">
          <view class="verifyInfo">
            <view class="label">‰ΩçÁΩÆÊ†°È™åÔºö</view>
            <button class="verifyBtn" @tap="getLocation(true)">ÁÇπÂáªÊ†°È™å</button>
          </view>
          <wd-radio-group v-model="postForm.addressInfo.isLocation" shape="dot" inline @change="getLocation">
            <wd-radio :value="0">ÁúüÂÆû</wd-radio>
            <wd-radio :value="1" class="isErr">ÊúâËØØ</wd-radio>
          </wd-radio-group>

          <view class="correct_text">
            <view class="label">Ê≠£Á°ÆÂú∞ÂùÄÔºö</view>
            <view class="textarea_box">
              <image class="address_img" src="http://116.62.107.90:8673/images/icons/address.png" mode="scaleToFill" />
              <textarea v-model="postForm.addressInfo.address" placeholder="ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÂú∞ÂùÄ"></textarea>
            </view>
          </view>

          <view class="upImg_box">
            <view class="label">Èó®Â∫óÂõæÁâá:<text class="up_tip">ËØ∑‰∏ä‰º†jpg„ÄÅpngÊ†ºÂºèÂõæÁâá</text></view>
            <view class="img_box">
              <view class="img_item" v-for="(img, idx) in postForm.addressInfo.storePic"
                @tap="lookover(postForm.addressInfo.storePic, idx, 0, 'storePic')">
                <image class="img" :src="baseURL + img" :key="idx" mode="scaleToFill" />
              </view>
              <view class="img_item up_btn" @tap.stop="upBtn('storePic', 0)">
                <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
              </view>
            </view>
            <view class="up_tip">ËØ∑ÊâìÂºÄÊâãÊú∫„ÄåÈöêÁßÅÊùÉÈôê„Äç</view>
          </view>

        </view>

        <view class="center center2" v-show="segmented == 1">
          <!-- <view v-for="item in 110">{{ workHandle.value }}</view> -->
          <!-- 2:Áª¥Êä§,3:Êñ∞Ë£Ö, 4ÔºöË°åËΩ¶ËÆ∞ÂΩï‰ª™Êñ∞Ë£Ö -->
          <view class="forms" v-if="workHandle.orderType == 2">
            <view class="form_center" v-for="(item, idx) in postForm.applyInfo" :key="idx" :class="{ ios: isIos }">
              <image class="operate_img" @tap="delWorkBtn" v-if="postForm.applyInfo.length > 1"
                src="http://116.62.107.90:8673/images/icons/delWork1.png" mode="scaleToFill" />
              <wd-input type="text" v-model="item.carPlate" label="ËΩ¶ÁâåÂè∑Á†Å/VINÁ†Å:" placeholder="ËØ∑ËæìÂÖ•" />
              <wd-select-picker filterable type="radio" label="ËΩ¶ËæÜÁ±ªÂûã" :columns="vehicleTypeList" v-model="item.carType"
                align-right />
              <view class="upImg_box">
                <view class="label">ÊñΩÂ∑•ÂâçÁÖßÁâá:</view>
                <view class="img_box">
                  <view class="img_item" v-for="(img, index) in item.beforeApplyPic"
                    @tap="lookover(item.beforeApplyPic, index, idx, 'beforeApplyPic')">
                    <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                  </view>
                  <view class="img_item up_btn" @tap="upBtn('beforeApplyPic', idx)">
                    <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                  </view>
                </view>
              </view>
              <wd-select-picker filterable type="radio" label="ÊïÖÈöúÂàÜÁ±ª" :columns="breakdownTypeList"
                v-model="item.faultType" align-right />
              <wd-select-picker filterable type="radio" label="ÊïÖÈöúÂéüÂõ†" :columns="failureCauseList"
                v-model="item.faultReason" align-right />
              <wd-select-picker label="Áª¥Êä§ÊñπÂºè" type="radio" required :columns="maintenanceMode" v-model="item.whType"
                align-right @change="maintenanceModeChange($event, item)" />
              <view v-if="item.whType == 'Áª¥Êä§Â§ÑÁêÜ'">
                <view class="correct_text">
                  <view class="label">Áª¥Êä§ÂÜÖÂÆπ</view>
                  <view class="textarea_box">
                    <textarea v-model="item.whContent" placeholder="ËØ∑ËæìÂÖ•Áª¥Êä§ÂÜÖÂÆπ"></textarea>
                  </view>
                </view>
                <view class="usePart">
                  <view class="label">‰ΩøÁî®ÈÉ®‰ª∂</view>
                  <view class="parts">
                    <view class="input_number">
                      <view class="label">‰∏ªÊú∫:</view>
                      <wd-input-number :min="0" v-model="item.ext1" />
                    </view>

                    <view class="input_number">
                      <view class="label">Á°¨Áõò:</view>
                      <wd-input-number :min="0" v-model="item.ext2" />
                    </view>
                    <view class="input_number">
                      <view class="label">UÁõò:</view>
                      <wd-input-number :min="0" v-model="item.ext3" />
                    </view>

                    <view class="input_number">
                      <view class="label">ÊëÑÂÉèÂ§¥:</view>
                      <wd-input-number :min="0" v-model="item.ext4" />
                    </view>

                    <view class="input_number">
                      <view class="label">GPSÂ§©Á∫ø:</view>
                      <wd-input-number :min="0" v-model="item.ext5" />
                    </view>

                    <view class="input_number">
                      <view class="label">4GÂ§©Á∫ø:</view>
                      <wd-input-number :min="0" v-model="item.ext6" />
                    </view>

                    <view class="input_number">
                      <view class="label">ÁîµÊ∫êÁ∫ø:</view>
                      <wd-input-number :min="0" v-model="item.ext7" />
                    </view>
                    <view class="input_number">
                      <view class="label">ËßÜÈ¢ëÁ∫ø:</view>
                      <wd-input-number :min="0" v-model="item.ext8" />
                    </view>

                    <view class="input_number">
                      <view class="label">ÊòæÁ§∫Â±è:</view>
                      <wd-input-number :min="0" v-model="item.ext9" />
                    </view>

                    <view class="input_number">
                      <view class="label">ËΩ¨Êé•Á∫ø:</view>
                      <wd-input-number :min="0" v-model="item.ext10" />
                    </view>

                    <view class="input_number">
                      <view class="label">Êú∫ËäØ:</view>
                      <wd-input-number :min="0" v-model="item.ext11" />
                    </view>

                    <view class="input_number">
                      <view class="label">ÁÅØÊùø:</view>
                      <wd-input-number :min="0" v-model="item.ext12" />
                    </view>
                    <view class="input_number">
                      <view class="label">Èò≤ÁàÜÁÆ°:</view>
                      <wd-input-number :min="0" v-model="item.ext13" />
                    </view>

                    <view class="input_number">
                      <view class="label">‰øùÈô©:</view>
                      <wd-input-number :min="0" v-model="item.ext14" />
                    </view>

                    <view class="input_number input_long">
                      <view class="label">ËæÖÊùê(ÈáëÂ±ûÂèòÂæÑ,Á¥ßÁº©ÂèòÂæÑ,Ê≥¢Á∫πÁÆ°Á≠â):</view>
                      <wd-input-number :min="0" v-model="item.ext15" />
                    </view>

                  </view>
                </view>
              </view>
              <view v-else-if="item.whType == 'Êõ¥Êç¢ÈÉ®‰ª∂'">
                <wd-select-picker filterable type="radio" label="Êõ¥Êç¢ÈÉ®‰ª∂" :columns="changeList" v-model="item.replacePart"
                  align-right />
                <wd-select-picker filterable type="radio" label="ËÆæÂ§áÂìÅÁâå" :columns="equipmentList"
                  v-model="item.deviceBrand" align-right />
                <wd-input type="text" v-model="item.deviceSerial" label="ËÆæÂ§áÂ∫èÂàóÂè∑:" placeholder="ËØ∑ËæìÂÖ•" />
                <wd-input type="text" v-model="item.deviceModel" label="ËÆæÂ§áÂûãÂè∑:" placeholder="ËØ∑ËæìÂÖ•" />
                <wd-input type="text" v-model="item.simNum" label="SIMÂç°Âè∑:" placeholder="ËØ∑ËæìÂÖ•" />
                <wd-select-picker filterable label="ÈÄöÈÅìÁ±ªÂûã" :columns="aisleList" v-model="item.channelType" align-right />
              </view>

              <view class="upImg_box">
                <view class="label">ÊñΩÂ∑•ÂêéÁÖßÁâá:</view>
                <view class="img_box"> <!-- afterApplyPic -->
                  <view class="img_item" v-for="(img, index) in item.afterApplyPic"
                    @tap="lookover(item.afterApplyPic, index, idx, 'afterApplyPic')">
                    <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                  </view>
                  <view class="img_item up_btn" @tap="upBtn('afterApplyPic', idx)">
                    <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                  </view>
                </view>
              </view>

              <view class="correct_text" style="border: none;">
                <view class="label">Â§áÊ≥®</view>
                <view class="textarea_box">
                  <textarea v-model="item.remark" placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®"></textarea>
                </view>
              </view>
            </view>
          </view>
          <view class="forms" v-if="workHandle.orderType == 3">
            <view class="form_center" v-for="(item, idx) in postForm.applyInfo" :key="idx" :class="{ ios: isIos }">
              <wd-select-picker filterable type="radio" label="ËÆæÂ§áÁ±ªÂûã" :columns="carTypeList" v-model="item.deviceType"
                align-right @change="carTypeChange(item)" />
              <wd-input type="text" v-model="item.carPlate" label="ËΩ¶ÁâåÂè∑Á†Å/VINÁ†Å:" placeholder="ËØ∑ËæìÂÖ•" />
              <wd-select-picker filterable type="radio" label="ËΩ¶ËæÜÁ±ªÂûã" :columns="vehicleTypeList" v-model="item.carType"
                align-right />

              <view class="upImg_box" v-if="item.deviceType && item.deviceType != 'Ê±ΩËΩ¶Ë°åÈ©∂ËÆ∞ÂΩï‰ª™'">
                <view class="label">ÊñΩÂ∑•ÂâçÁÖßÁâá:</view>
                <view class="img_box">
                  <view class="img_item" v-for="(img, index) in item.beforeApplyPic"
                    @tap="lookover(item.beforeApplyPic, index, idx, 'beforeApplyPic')">
                    <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                  </view>
                  <view class="img_item up_btn" @tap="upBtn('beforeApplyPic', idx)">
                    <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                  </view>
                </view>
              </view>

              <wd-select-picker filterable type="radio" label="ËÆæÂ§áÂìÅÁâå" :columns="equipmentList" v-model="item.deviceBrand"
                align-right />
              <wd-input type="text" v-model="item.deviceSerial" label="ËÆæÂ§áÂ∫èÂàóÂè∑:" placeholder="ËØ∑ËæìÂÖ•" />
              <wd-input type="text" v-model="item.deviceModel" label="ËÆæÂ§áÂûãÂè∑:" placeholder="ËØ∑ËæìÂÖ•" />
              <wd-input type="text" v-model="item.simNum" label="SIMÂç°Âè∑:" placeholder="ËØ∑ËæìÂÖ•" />
              <wd-select-picker filterable label="ÈÄöÈÅìÁ±ªÂûã" :columns="aisleList" v-model="item.channelType" align-right />

              <view class="correct_text" style="border: none;" v-if="item.deviceType && item.deviceType != 'Ê±ΩËΩ¶Ë°åÈ©∂ËÆ∞ÂΩï‰ª™'">
                <view class="label">Êñ∞Ë£ÖÂÜÖÂÆπ</view>
                <view class="textarea_box">
                  <textarea v-model="item.xzContent" placeholder="ËØ∑ËæìÂÖ•Êñ∞Ë£ÖÂÜÖÂÆπ"></textarea>
                </view>
              </view>

              <view class="upImg_box" v-if="item.deviceType && item.deviceType != 'Ê±ΩËΩ¶Ë°åÈ©∂ËÆ∞ÂΩï‰ª™'">
                <view class="label">ÊñΩÂ∑•ÂêéÁÖßÁâá:</view>
                <view class="img_box"> <!-- afterApplyPic -->
                  <view class="img_item" v-for="(img, index) in item.afterApplyPic"
                    @tap="lookover(item.afterApplyPic, index, idx, 'afterApplyPic')">
                    <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                  </view>
                  <view class="img_item up_btn" @tap="upBtn('afterApplyPic', idx)">
                    <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                  </view>
                </view>
              </view>

              <view class="up_list" v-if="item.deviceType == 'Ê±ΩËΩ¶Ë°åÈ©∂ËÆ∞ÂΩï‰ª™'">
                <view class="upImg_box">
                  <view class="label">Ë°åÈ©∂ËØÅÈôÑ‰ª∂:</view>
                  <view class="img_box">
                    <view class="img_item" v-for="(img, index) in item.drivingLicense"
                      @tap="lookover(item.drivingLicense, index, idx, 'drivingLicense')">
                      <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                    </view>
                    <view class="img_item up_btn" @tap="upBtns(item.drivingLicense, idx)">
                      <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                    </view>
                  </view>
                </view>

                <view class="upImg_box">
                  <view class="label">È©æÈ©∂ËØÅÈôÑ‰ª∂:</view>
                  <view class="img_box">
                    <view class="img_item" v-for="(img, index) in item.driverLicense"
                      @tap="lookover(item.driverLicense, index, idx, 'driverLicense')">
                      <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                    </view>
                    <view class="img_item up_btn" @tap="upBtns(item.driverLicense, idx)">
                      <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                    </view>
                  </view>
                </view>

                <view class="upImg_box">
                  <view class="label">ÁÆ°ÁêÜÂëò‰ø°ÊÅØÈôÑ‰ª∂:</view>
                  <view class="img_box">
                    <view class="img_item" v-for="(img, index) in item.managerFile"
                      @tap="lookover(item.managerFile, index, idx, 'managerFile')">
                      <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                    </view>
                    <view class="img_item up_btn" @tap="upBtns(item.managerFile, idx)">
                      <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                    </view>
                  </view>
                </view>

                <view class="upImg_box">
                  <view class="label">ÁîµÊ∞îÈôÑ‰ª∂:</view>
                  <view class="img_box">
                    <view class="img_item" v-for="(img, index) in item.electricalFile"
                      @tap="lookover(item.electricalFile, index, idx, 'electricalFile')">
                      <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                    </view>
                    <view class="img_item up_btn" @tap="upBtns(item.electricalFile, idx)">
                      <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                    </view>
                  </view>
                </view>

                <view class="upImg_box">
                  <view class="label">ÊÄªÁ∫øÈôÑ‰ª∂:</view>
                  <view class="img_box">
                    <view class="img_item" v-for="(img, index) in item.busFile"
                      @tap="lookover(item.busFile, index, idx, 'busFile')">
                      <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                    </view>
                    <view class="img_item up_btn" @tap="upBtns(item.busFile, idx)">
                      <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                    </view>
                  </view>
                </view>

                <view class="upImg_box">
                  <view class="label">‰∏ªÊú∫ÁÖßÁâá:</view>
                  <view class="img_box">
                    <view class="img_item" v-for="(img, index) in item.hostPic"
                      @tap="lookover(item.hostPic, index, idx, 'hostPic')">
                      <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                    </view>
                    <view class="img_item up_btn" @tap="upBtns(item.hostPic, idx)">
                      <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                    </view>
                  </view>
                </view>

                <view class="upImg_box">
                  <view class="label">ÈôÑ‰ª∂Ê£ÄÊü•:</view>
                  <view class="img_box">
                    <view class="img_item" v-for="(img, index) in item.attachment"
                      @tap="lookover(item.attachment, index, idx, 'attachment')">
                      <image class="img" :src="baseURL + img" :key="index" mode="scaleToFill" />
                    </view>
                    <view class="img_item up_btn" @tap="upBtns(item.attachment, idx)">
                      <image class="up_img" src="http://116.62.107.90:8673/images/fns/up_img.png" mode="scaleToFill" />
                    </view>
                  </view>
                </view>

              </view>

              <view class="correct_text" style="border: none;">
                <view class="label">Â§áÊ≥®</view>
                <view class="textarea_box">
                  <textarea v-model="item.remark" placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®"></textarea>
                </view>
              </view>

            </view>

          </view>
        </view>

        <view class="center center3" v-show="segmented == 2">
          <view class="list-item">
            <view class="list-item-top">
              <view class="name">
                <view class="tag"></view>
                <text>ËøêÁª¥Á≠æÂ≠ó</text>
              </view>
            </view>
            <view class="sign" @tap="goSign('engieeSign')">
              <image class="sign_img" v-if="postForm.signInfo.engieeSign" :src="baseURL + postForm.signInfo.engieeSign"
                mode="scaleToFill" />
            </view>
          </view>

          <view class="list-item">
            <view class="list-item-top">
              <view class="name">
                <view class="tag"></view>
                <text>Áî®Êà∑Á≠æÂ≠ó</text>
              </view>
              <!-- <view class="btns" v-if="userSign">
                <button class="btn" @tap="ClearSign('userSign')">Ê∏ÖÈô§</button>
                <button class="btn" @tap="SaveSign('userSign')"
                  v-if="!postForm.signInfo.userSign || userSign">‰øùÂ≠ò</button>
              </view> -->
            </view>
            <view class="sign" @tap="goSign('userSign')">
              <image class="sign_img" v-if="postForm.signInfo.userSign" :src="baseURL + postForm.signInfo.userSign"
                mode="scaleToFill" />
            </view>
          </view>
        </view>

        <button class="foot_btn" v-if="segmented == 2" @tap="submitBtn">Êèê‰∫§Â∑•Âçï</button>
        <button class="foot_btn" v-else-if="segmented == 0" @tap="nextStep(1)">‰∏ã‰∏ÄÊ≠•</button>
        <button class="foot_btn" v-else-if="segmented == 1" @tap="nextStep(2)">‰∏ã‰∏ÄÊ≠•</button>
      </scroll-view>
    </view>
    <web-view ref="mywebview" :src="watermarkUrl" @message="handleMessage" @onPostMessage="handleMessage"
      class="webview" :fullscreen="false" v-if="openWebview" />
    <QreviewImage ref="previewImage" :urls="variableList" @onLongpress="onLongpress" />
    <wd-action-sheet v-model="sheetShow" :actions="sheetActions" @select="sheetSelect" />
  </view>
</template>
<style lang="scss" scoped>
.webview {
  width: 100vw;
  height: 100vh;
}

:deep(.wd-popup) {
  z-index: 9999;
}


:deep(.lime-signature) {
  width: 100% !important;
  height: 100% !important;

  .lime-signature__canvas {
    width: 100% !important;
    height: 100% !important;

    uni-resize-sensor {
      width: 100% !important;
      height: 100% !important;
    }

    * {
      width: 100% !important;
      height: 100% !important;
    }
  }
}

.handleWork {
  display: flex;
  flex-direction: column;
  width: 100%;
  height: 100vh;
  // overflow: hidden;
  background-color: #f7f7fc;

  .details_center {
    flex: 1;
    padding: 30rpx;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    height: 88%;

    .segmented_center {
      width: 100%;
      flex: 1;
    }

    .center {

      padding: 30rpx;
      box-sizing: border-box;

      .label {
        font-size: 24rpx;
        color: #AAAAAA;
        margin-right: 10rpx;

      }

      .up_tip {
        font-size: 18rpx;
        color: #AAAAAA;
      }

      .upImg_box {
        width: 100%;
        min-height: 160rpx;
        margin: 30rpx 0;

        .img_box {
          width: 100%;
          min-height: 120rpx;
          padding-top: 10rpx;
          display: flex;
          flex-wrap: wrap;
          box-sizing: border-box;

          .img_item {
            width: 116rpx;
            height: 116rpx;
            margin: 0 10rpx 10rpx 0;

            .img {
              width: 116rpx;
              height: 116rpx;
            }

          }

          .up_btn {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #F4F4F4;
            border-radius: 7rpx 7rpx 7rpx 7rpx;

            .up_img {
              width: 43rpx;
              height: 33rpx;
            }
          }
        }
      }

      .correct_text {
        width: 100%;
        height: 180rpx;
        display: flex;
        flex-direction: column;
        margin: 30rpx 0;

        .textarea_box {
          width: 100%;
          height: 139rpx;
          background: #F4F4F4;
          margin-top: 10rpx;
          border-radius: 7rpx 7rpx 7rpx 7rpx;
          padding: 10rpx;
          box-sizing: border-box;
          font-size: 24rpx;
          position: relative;
          overflow: hidden;

          .address_img {
            width: 24rpx;
            height: 32rpx;
            position: absolute;
            right: 10rpx;
            bottom: 10rpx;
          }

          textarea {
            font-size: 24rpx;

            &::placeholder {
              font-size: 24rpx;
            }
          }
        }
      }

    }

    .center1 {
      width: 100%;
      min-height: 600rpx;
      background-color: #fff;
      box-shadow: 0rpx 5rpx 11rpx 2rpx rgba(0, 0, 0, 0.09);
      border-radius: 14rpx 14rpx 14rpx 14rpx;

      :deep(.wd-radio-group) {
        margin-left: 150rpx;
        height: 60rpx;
        line-height: 60rpx;

        .isErr {
          .wd-radio__label {
            color: #FF0000;
          }

          .wd-radio__shape {
            border-color: #FF0000;
            background-color: #FF0000;
          }
        }
      }



      .verifyInfo {
        width: 100%;
        height: 40rpx;
        display: flex;
        align-items: center;

        .label {
          line-height: 40rpx;
        }

        .verifyBtn {
          min-width: 120rpx;
          height: 40rpx;
          font-size: 22rpx;
          line-height: 40rpx;
          color: #FFFFFF;
          background: linear-gradient(90deg, #4557D1 0%, #75DBED 100%);
          border-radius: 7rpx 7rpx 7rpx 7rpx;
          margin-left: 40rpx;
        }

      }
    }

    .center2 {
      width: 100%;
      min-height: 800rpx;
      padding: 0;

      .forms {
        position: relative;

        .up_list {
          width: 100%;
        }

        .operate_img {
          position: absolute;
          right: 0rpx;
          top: 0rpx;
          z-index: 9;
        }

        .form_center {
          padding: 20rpx;
          box-sizing: border-box;
          width: 100%;
          background-color: #fff;
          box-shadow: 0rpx 5rpx 11rpx 2rpx rgba(0, 0, 0, 0.09);
          border-radius: 14rpx 14rpx 14rpx 14rpx;
          margin-bottom: 30rpx;
          position: relative;

          &.ios {
            :deep(.wd-popup) {
              width: 90%;
              left: 5%;
              z-index: 9999;
            }
          }
        }

        :deep(.wd-input) {
          padding: 18rpx 10rpx 8rpx 0 !important;
          height: 60rpx;
          border-bottom: 2rpx solid #EFEFEF;

          .wd-input__label-inner {
            font-size: 24rpx;
            color: #AAAAAA;
          }

          .wd-input__inner {
            text-align: right;
            padding-right: 36rpx;
            box-sizing: border-box;
          }

          .uni-input-placeholder {
            font-size: 24rpx;
            color: #000000;
          }
        }

        :deep(.wd-select-picker) {
          padding: 0 !important;
          border-bottom: 2rpx solid #EFEFEF;

          .wd-select-picker__field {
            height: 100%;
          }

          .wd-select-picker__cell {
            padding-left: 0;
            padding-right: 0;
          }

          .wd-select-picker__label {
            font-size: 24rpx;
            color: #AAAAAA;
          }

          .wd-select-picker__value--placeholder {
            font-size: 24rpx;
            color: #000000;
          }

        }

        .upImg_box {
          margin: 20rpx 0 0 0;
          padding-bottom: 10rpx;
          border-bottom: 2rpx solid #EFEFEF;
        }

        .correct_text {
          margin: 20rpx 0 0 0;
          padding-bottom: 20rpx;
          border-bottom: 2rpx solid #EFEFEF;
        }

        .usePart {
          width: 100%;
          min-width: 600rpx;
          margin: 20rpx 0 0 0;
          padding-bottom: 20rpx;

          .parts {
            width: 100%;
            background: #F4F4F4;
            border-radius: 7rpx 7rpx 7rpx 7rpx;
            margin-top: 10rpx;
            display: flex;
            flex-wrap: wrap;
            padding: 20rpx 10rpx;
            box-sizing: border-box;

            .input_number {
              width: 50%;
              height: 66rpx;
              display: flex;
              align-items: center;
              justify-content: flex-end;
              padding-right: 20rpx;
              box-sizing: border-box;
              flex-wrap: nowrap;

              .label {
                color: #000000;
              }

              &.input_long {
                width: 100% !important;

                .label {}
              }
            }

            :deep(.wd-input-number) {
              //‰∏çÊç¢Ë°å
              white-space: nowrap;

              .wd-input-number__action {
                width: 50rpx;
                height: 50rpx;
                border-radius: 50%;
                overflow: hidden;
                background-color: #55A4FF;
                color: #fff;
                transform: scale(.7);

                // &::before{
                //   font-size: 22rpx !important;
                // }
              }

              .wd-input-number__action-icon {
                // font-size: 20rpx !important;
                // line-height: 24rpx !important;
                // text-align: center;
              }

              .wd-input-number__inner {
                border: 2rpx solid #55A4FF;
                box-sizing: border-box;
                border-radius: 4rpx;
                padding: 0 3rpx;
              }
            }
          }
        }

      }
    }


    .center3 {
      min-height: 800rpx;
      background-color: #fff;
      box-shadow: 0rpx 5rpx 11rpx 2rpx rgba(0, 0, 0, 0.09);
      border-radius: 14rpx 14rpx 14rpx 14rpx;

      .list-item {
        margin-bottom: 30rpx;

        .list-item-top {
          display: flex;
          height: 80rpx;
          justify-content: space-between;
          align-items: center;

          .name {
            display: flex;
            align-items: center;
            font-size: 26rpx;
            color: #191919;
            font-weight: bold;
          }

          .tag {
            width: 10rpx;
            height: 32rpx;
            background: #1082ff;
            margin-right: 10rpx;
          }

          .btns {
            display: flex;
            align-items: center;
          }

          .btn {
            width: 120rpx;
            height: 48rpx;
            font-size: 24rpx;
            line-height: 48rpx;
            color: #FFFFFF;
            background: linear-gradient(90deg, #4557D1 0%, #75DBED 100%);
            border-radius: 7rpx 7rpx 7rpx 7rpx;
            margin: 0 20rpx 0 0;
          }
        }

        .sign {
          width: 100%;
          height: 240rpx;
          background: #f4f4f4;
          border-radius: 10rpx;
          overflow: hidden;

          .sign_img {
            width: 100%;
            height: 100%;
          }
        }

        .title::before {
          left: -30rpx;
        }
      }
    }

    .foot_btn {
      width: 90%;
      height: 90rpx;
      font-size: 36rpx;
      color: #FFFFFF;
      margin: 100rpx auto 100rpx auto;
      background: linear-gradient(90deg, #1082FF 0%, #5FA9FF 100%);
      border-radius: 14rpx 14rpx 14rpx 14rpx;
    }

    .operate_img {
      width: 36rpx;
      height: 36rpx;
      margin-left: 6rpx;
    }

    .top_segmented {
      width: 100%;
      height: 90rpx;
      background: #FFFFFF;
      box-shadow: 0rpx 4rpx 7rpx 2rpx rgba(0, 0, 0, 0.16);
      border-radius: 9rpx 9rpx 9rpx 9rpx;
      padding: 0 30rpx;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      margin-bottom: 30rpx;
      position: relative;

      .operate_box {
        width: 80rpx;
        height: 100%;
        position: absolute;
        right: 30%;
        top: 0;
        display: flex;
        align-items: center;
        z-index: 9;
      }

      :deep(.wd-tabs) {
        .is-active {
          color: #1082FF !important;
        }

        .wd-tabs__nav-item {
          font-size: 28rpx;
          color: #9B9B9B;
        }

        .wd-tabs__line {
          background: #1082FF;
        }
      }

    }


  }

}
</style>
